<div>google雲端硬碟about測試</div>
<button onclick="about()">about</button>
<button onclick="root()">root</button>
<button onclick="special()">special</button>
<button onclick="trash()">trash</button>
<button onclick="test()">test</button>
<script>
var token='ya29.a0AfB_byB-PTkZX59LePnmxfrAgfmHmsZB73boQfqw3G6IQP5L2SkYgOK-9xKGWFW-ZDuWOedNoZY8syKEsOMzJFPcwQogLyQ3AjVDEEcwuWQc5zQoCAtJDDWdJqhep6ynBO_a56wOzD4N7XdU_ZBPcIrfIdNBwrdadIA0aCgYKAWcSARMSFQHGX2MizKoXKAS9Y9CmZT37imUK4Q0171'
var Token='ya29.a0AfB_byD32CMT75upxytQBhl1r54o0EFKZLI1pUPnz4l0vAZYL6yVkEPQ9Vh2Z0OfyQctmqXPAeyHMq7A_bXL6lX5V9yD27xZynzbg-sk4mBuvt5kL18Ve3U8Fa8SmJNLZJJz6fKLPOjYLcxH6cWeyIVwg-8OkD-26ZEaCgYKAUMSARESFQHGX2MiprikECltPqrQwI2RbINOgQ0170'
var xhr=new XMLHttpRequest()
function about(){
 xhr.open('GET',`https://www.googleapis.com/drive/v3/about?fields=storageQuota`,true)
 xhr.responseType='json'
 xhr.setRequestHeader('Authorization','Bearer '+token)
 xhr.send()
 xhr.onload=()=>{console.log('onload',xhr.response)}
}
function root(){
 xhr.open('GET',`https://www.googleapis.com/drive/v3/files?q='root' in parents and trashed=false&fields=files(mimeType,name)&pageSize=1000`,true)
 xhr.responseType='json'
 xhr.setRequestHeader('Authorization','Bearer '+token)
 xhr.send()
 xhr.onload=()=>{
  console.log(xhr.response.files)
 }
}
function special(){
 let result=[]
 loop('')
 function loop(pageToken){
  xhr.open('GET',`https://www.googleapis.com/drive/v3/files?q='me' in owners and trashed=false&fields=nextPageToken,files(mimeType,name,parents)&pageSize=1000&pageToken=${pageToken}`,true)
  xhr.responseType='json'
  xhr.setRequestHeader('Authorization','Bearer '+token)
  xhr.send()
  xhr.onload=()=>{
   console.log(xhr.response.files)
   result=result.concat(xhr.response.files.filter(item=>!item.parents||item.parents[0].length==19))//!item.parents代表無父目錄(unorganized)；item.parents[0].length==19代表有父目錄(id長度只有19為root)
   if(xhr.response.nextPageToken){loop(xhr.response.nextPageToken)}else{console.log(result)}
  }//onload
 }//loop
}//special
function trash(){
 let result=[]
 loop('')
 function loop(pageToken){
  xhr.open('GET',`https://www.googleapis.com/drive/v3/files?q=trashed=true&fields=nextPageToken,files(mimeType,name,parents)&pageSize=1000&pageToken=${pageToken}`,true)
  xhr.responseType='json'
  xhr.setRequestHeader('Authorization','Bearer '+token)
  xhr.send()
  xhr.onload=()=>{
   console.log(xhr.response.files)
   result=result.concat(xhr.response.files)
   if(xhr.response.nextPageToken){loop(xhr.response.nextPageToken)}else{console.log(result)}
  }//onload
 }//loop
}//trash


let missions=[],num=0
async function test(){
 const oldId='1N__5vR2pwHDNDgTic7DHPSjr44lo3W5f',newId=await first(oldId)
 missions=missions.concat(await second(oldId,newId))
 third()
}



async function first(oldId){
 let res=await fetch(`https://www.googleapis.com/drive/v3/files/${oldId}?fields=mimeType,name,parents,modifiedTime`,{headers:{'Authorization':'Bearer '+token}})
 const{mimeType,name,parents,modifiedTime}=await res.json()//取舊資料夾資訊
 res=await fetch(`https://www.googleapis.com/drive/v3/files`,{method:"POST",headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}
 ,body:JSON.stringify({mimeType:mimeType,name:name,parents:parents,folderColorRgb:"#f83a22"})})//建立紅新資料夾
 const newId=(await res.json()).id
 await fetch(`https://www.googleapis.com/drive/v3/files/${newId}/permissions/anyoneWithLink`,{method:"PATCH",headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}
 ,body:JSON.stringify({role:'writer'})})//知道連結的任何人，權限改編輯者
 fetch(`https://www.googleapis.com/drive/v3/files/${newId}`,{method:"PATCH",headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}
 ,body:JSON.stringify({modifiedTime:modifiedTime})})//改回舊資料夾時間
 return newId
}

async function second(oldId,newId){
 let arr=[]
 return await loop('')
 async function loop(pageToken){
  const res=await fetch(`https://www.googleapis.com/drive/v3/files?q='${oldId}' in parents and trashed=false&orderBy=folder&fields=nextPageToken,files(mimeType,name,id,modifiedTime)&pageSize=1000&pageToken=${pageToken}`
  ,{headers:{'Authorization':'Bearer '+token}})
  const data=await res.json()
  arr=arr.concat(data.files)
  if(data.nextPageToken)return await loop(data.nextPageToken)
  else for(const i in arr){arr[i].parents=[newId]};return arr
 }
}

async function third(){
 console.log(num,missions)
 if(missions.length==0)return
 const{mimeType,name,id,modifiedTime,parents}=missions[0],mission=missions[0]
 if(mimeType=='application/vnd.google-apps.folder'){
  const res=await fetch(`https://www.googleapis.com/drive/v3/files`,{method:"POST",headers:{'Authorization':'Bearer '+Token,'Content-Type':'application/json'}
  ,body:JSON.stringify({mimeType:mimeType,name:name,parents:parents,modifiedTime:modifiedTime})})//建立新資料夾


  const{id:newId,error}=await res.json()
  if(error){third();return}
  missions=missions.concat(await second(id,newId))
  missions.splice(0,1);third()
 }
 else{
  let late=true;num++
  fetch(`https://www.googleapis.com/drive/v3/files/${id}/copy?${Math.random()}`,{method:"POST",headers:{'Authorization':'Bearer '+Token,'Content-Type':'application/json'}
  ,body:JSON.stringify({parents:parents,modifiedTime:modifiedTime})})//複製舊檔案
  .then(res=>res.json())
  .then(data=>{if(late){missions.splice(0,1);third()};if(data.error){missions.push(mission);if(missions.length==1)third()};num--})
  if(num<100){late=false;missions.splice(0,1);third()}
 }
}

</script>