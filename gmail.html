<style>
body{background-color:black;color:white;font-family:細明體}
table,th,td{border:1px solid lime;white-space:nowrap}
button{visibility:hidden}
</style>
<button onclick="read()">讀取</button>
<table style="display:none">
<tr><td>Gmail</td><td>Trash用量</td><td>Drive用量</td><td>總用量</td><td>剩餘量</td><td>root、unorganized</td></tr>
</table>
<script>
 var table=document.querySelector('table'),tr
 var onibgObj={},quantity=0
 fetch('https://script.google.com/macros/s/AKfycbxIKVXrmO86jLZOu0NDDoN6d3yutuCEYa-JOQ0qTHCZvq8i7IWkNCVwweTpe9dxgBH4rA/exec?onibg')
 .then(res=>res.text())
 .then(data=>{let i=0
  for(const item of data.split('\n')){
   const mail_url=item.split(',')
   if(!mail_url[1].startsWith('https://'))continue
   onibgObj[mail_url[0]]={}
   onibgObj[mail_url[0]].url=mail_url[1]
   onibgObj[mail_url[0]].row=++i
   getToken(mail_url)
   const row=document.createElement('tr')
   const cell=document.createElement('td')
   cell.textContent=mail_url[0]
   row.appendChild(cell)
   row.innerHTML+='<td onclick="console.log("'+'hello'+'")"></td><td></td><td></td><td style="text-align:right"></td><td></td>'
   table.appendChild(row)
   table.style.display='table';
  }
 tr=document.querySelectorAll('tr')
})
function getToken(mail_url){
 fetch(mail_url[1])
 .then(res=>res.text())
 .then(data=>{
  onibgObj[mail_url[0]].token=data
  if(!quantity){quantity=tr.length-1}else{quantity--}
  if(quantity==1){quantity=0;document.querySelector('button').style.visibility='visible'}
 })
}
setInterval(()=>{
 for(const mail in onibgObj){getToken([mail,onibgObj[mail].url])}
},3000000)
function read(){
 for(const mail in onibgObj){
  const row=tr[onibgObj[mail].row]
  for(let i=1;i<=5;i++){row.children[i].textContent='';row.children[i].style.backgroundColor='black'}
  trash(mail);if(onibgObj[mail].row>3)special(mail)
  fetch('https://www.googleapis.com/drive/v3/about?fields=storageQuota&'+mail,{headers:{'Authorization':'Bearer '+onibgObj[mail].token}})
  .then(res=>res.json())
  .then(data=>{
    const remain=data.storageQuota.limit-data.storageQuota.usage
    row.children[1].textContent=data.storageQuota.usageInDriveTrash+row.children[1].textContent
    row.children[2].textContent=data.storageQuota.usageInDrive
    if(data.storageQuota.usageInDriveTrash!=0){row.children[1].style.backgroundColor='red'}else{row.children[1].style.backgroundColor='black'}
    if(onibgObj[mail].row<=3)return
    row.children[3].textContent=data.storageQuota.usage
    let remainG=Math.floor(remain/1073741824*100)/100+''
    const index=remainG.indexOf('.');if(index==-1){remainG+='.'}
    remainG=remainG.slice(0,index).padStart(2,' ')+remainG.slice(index).padEnd(3,'0')+'G'
    row.children[4].textContent=remain+'＝'+remainG
  //row.children[4].textContent=remain+'＝'+((remain/1073741824).toFixed(2)+'G').padStart(6,' ')
    if(row.children[2].textContent!=row.children[3].textContent){row.children[3].style.backgroundColor='red'}else{row.children[3].style.backgroundColor='black'}
  }) 
 }
}
function special(mail){
 let result=[],xhr=new XMLHttpRequest()
 loop('')
 function loop(pageToken){
  xhr.open('GET',`https://www.googleapis.com/drive/v3/files?q='me' in owners and trashed=false&fields=nextPageToken,files(mimeType,name,parents)&pageSize=1000&pageToken=${pageToken}&${mail}`,true)
  xhr.responseType='json'
  xhr.setRequestHeader('Authorization','Bearer '+onibgObj[mail].token)
  xhr.send()
  xhr.onload=()=>{
   result=result.concat(xhr.response.files.filter(item=>!item.parents||item.parents[0].length==19))//!item.parents代表無父目錄(unorganized)；item.parents[0].length==19代表有父目錄(id長度只有19為root)
   if(xhr.response.nextPageToken){loop(xhr.response.nextPageToken)}
   else{
    const row=tr[onibgObj[mail].row]
    row.children[5].textContent=JSON.stringify(result)
    if(result.length==1&&result[0].name=='onibg'){row.children[5].style.backgroundColor='black'}else{row.children[5].style.backgroundColor='red'}
   }
  }
 }
}
function trash(mail){
 let result=[],xhr=new XMLHttpRequest()
 loop('')
 function loop(pageToken){
  xhr.open('GET',`https://www.googleapis.com/drive/v3/files?q=trashed=true&fields=nextPageToken,files(mimeType,name,parents)&pageSize=1000&pageToken=${pageToken}&${mail}`,true)
  xhr.responseType='json'
  xhr.setRequestHeader('Authorization','Bearer '+onibgObj[mail].token)
  xhr.send()
  xhr.onload=()=>{
   result=result.concat(xhr.response.files)
   if(xhr.response.nextPageToken){loop(xhr.response.nextPageToken)}
   else{console.log(result);tr[onibgObj[mail].row].children[1].textContent+='共'+result.length+'個'}
  }
 }
}
function emptyTrash(x){
 var result=confirm('確定要清空垃圾桶？')
 console.log(result,x)
}
</script>
  