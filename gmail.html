<style>
body{background-color:black;color:white}
table,th,td{border:1px solid lime}
button{visibility:hidden}
</style>
<button onclick="read()">read</button>
<table style="display:none">
<tr><td>Gmail</td><td>Trash用量</td><td>Drive用量</td><td>總用量</td><td>剩餘量</td></tr>
</table>
<script>
 var table=document.querySelector('table'),tr
 var onibgObj={},quantity=0
 fetch('https://script.google.com/macros/s/AKfycbxIKVXrmO86jLZOu0NDDoN6d3yutuCEYa-JOQ0qTHCZvq8i7IWkNCVwweTpe9dxgBH4rA/exec?onibg')
 .then(res=>res.text())
 .then(data=>{let i=0
  for(const item of data.split('\n')){
   const mail_url=item.split(',')
   onibgObj[mail_url[0]]={}
   onibgObj[mail_url[0]].url=mail_url[1]
   onibgObj[mail_url[0]].row=++i
   getToken(mail_url)
   const row=document.createElement('tr')
   const cell=document.createElement('td')
   cell.textContent=mail_url[0]
   row.appendChild(cell)
   row.innerHTML+='<td></td><td></td><td></td><td></td>'
   table.appendChild(row)
   table.style.display='table';
  }
 tr=document.querySelectorAll('tr')
})
function getToken(mail_url){
 fetch(mail_url[1])
 .then(res=>res.text())
 .then(data=>{
  onibgObj[mail_url[0]].token=data
  if(!quantity){quantity=tr.length-1}else{quantity--}
  if(quantity==1){quantity=0;document.querySelector('button').style.visibility='visible'}
 })
}
setInterval(()=>{
 for(const mail in onibgObj){getToken([mail,onibgObj[mail].url])}
},3000000)
function read(){
 for(const mail in onibgObj){
  fetch('https://www.googleapis.com/drive/v3/about?fields=storageQuota',{headers:{'Authorization':'Bearer '+onibgObj[mail].token}})
  .then(res=>res.json())
  .then(data=>{
    const row=tr[onibgObj[mail].row],remain=data.storageQuota.limit-data.storageQuota.usage
    row.children[1].textContent=data.storageQuota.usageInDriveTrash
    row.children[2].textContent=data.storageQuota.usageInDrive
    row.children[3].textContent=data.storageQuota.usage
    row.children[4].textContent=remain+'＝'+(remain/1073741824).toFixed(2)+'G'
    if(row.children[2].textContent!=row.children[3].textContent){row.children[3].style.backgroundColor='red'}
  }) 
 }
}






console.log(onibgObj)


</script>
  